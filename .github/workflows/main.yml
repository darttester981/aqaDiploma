name: playwright api and ui test

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  diplomaTests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
      
      - name: Setup Node.js environment
        uses: actions/setup-node@v6.2.0
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ npm –ø–∞–∫–µ—Ç—ã –∏–∑ package.json
        run: npm ci
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤
        run: npx playwright install --with-deps
      
      - name: –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
        run: npm t
        continue-on-error: true
      
      - name: Get test statistics
        if: always()
        id: stats
        run: |
          PASSED=$(find allure-results -name '*-result.json' -exec grep -l '"status":"passed"' {} \; 2>/dev/null | wc -l || echo 0)
          FAILED=$(find allure-results -name '*-result.json' -exec grep -l '"status":"failed"' {} \; 2>/dev/null | wc -l || echo 0)
          BROKEN=$(find allure-results -name '*-result.json' -exec grep -l '"status":"broken"' {} \; 2>/dev/null | wc -l || echo 0)
          SKIPPED=$(find allure-results -name '*-result.json' -exec grep -l '"status":"skipped"' {} \; 2>/dev/null | wc -l || echo 0)
          TOTAL=$((PASSED + FAILED + BROKEN + SKIPPED))
          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "broken=$BROKEN" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Passed: $PASSED"
          echo "‚ùå Failed: $FAILED"
          echo "üí• Broken: $BROKEN"
          echo "‚è≠ Skipped: $SKIPPED"
          echo "üìä Total: $TOTAL"
      
      - name: Get Allure history
        uses: actions/checkout@v4
        if: always()
        continue-on-error: true
        with:
          ref: gh-pages
          path: gh-pages
      
      - name: Allure Report with history
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_history: allure-history
          keep_reports: 20
      
      - name: Deploy Allure report to Github Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history
      
      - name: Setup Allurectl
        if: always()
        uses: allure-framework/setup-allurectl@v1
        with:
          allure-endpoint: ${{ secrets.ALLURE_ENDPOINT }}
          allure-token: ${{ secrets.ALLURE_TOKEN }}
      
      - name: Send results to Allure TestOps
        if: always()
        env:
          ALLURE_PROJECT_ID: ${{ secrets.ALLURE_PROJECT_ID }}
        run: |
          allurectl upload allure-results \
            --project-id $ALLURE_PROJECT_ID \
            --launch-name "Playwright Tests #${{ github.run_number }}" \
            --launch-tags "github-actions" "playwright" "branch:${{ github.ref_name }}"
      
      - name: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å allure 3 –æ—Ç—á–µ—Ç –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
        run: npx allure awesome ./allure-results --single-file
        continue-on-error: true
        if: always()
      
      - name: Upload a Build Artifact
        uses: actions/upload-artifact@v6.0.0
        continue-on-error: true
        if: always()
        with:
          name: allure single file
          path: |
            allure-report/index.html
            allure-results
            playwright-report
      
      - name: Send Telegram notification
        if: always()
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          PASSED="${{ steps.stats.outputs.passed }}"
          FAILED="${{ steps.stats.outputs.failed }}"
          BROKEN="${{ steps.stats.outputs.broken }}"
          SKIPPED="${{ steps.stats.outputs.skipped }}"
          TOTAL="${{ steps.stats.outputs.total }}"
          
          if [ "$TOTAL" -gt 0 ]; then
            PERCENT=$((PASSED * 100 / TOTAL))
          else
            PERCENT=0
          fi
          
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            EMOJI="‚úÖ"
          else
            EMOJI="‚ùå"
          fi
          
          MESSAGE="${EMOJI} *Playwright Tests - Run #${{ github.run_number }}*%0A%0A"
          MESSAGE="${MESSAGE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A"
          MESSAGE="${MESSAGE}‚úÖ Passed: *${PASSED}* (${PERCENT}%%)%0A"
          MESSAGE="${MESSAGE}‚ùå Failed: *${FAILED}*%0A"
          MESSAGE="${MESSAGE}üí• Broken: *${BROKEN}*%0A"
          MESSAGE="${MESSAGE}‚è≠ Skipped: *${SKIPPED}*%0A"
          MESSAGE="${MESSAGE}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ%0A"
          MESSAGE="${MESSAGE}üìä Total: *${TOTAL}*%0A%0A"
          MESSAGE="${MESSAGE}üë§ Author: ${{ github.actor }}%0A"
          MESSAGE="${MESSAGE}üåø Branch: ${{ github.ref_name }}%0A%0A"
          MESSAGE="${MESSAGE}üìä [Allure Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})%0A"
          MESSAGE="${MESSAGE}üîó [Allure TestOps](${{ secrets.ALLURE_ENDPOINT }}/project/${{ secrets.ALLURE_PROJECT_ID }})%0A"
          MESSAGE="${MESSAGE}üìã [GitHub Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="${MESSAGE}"
